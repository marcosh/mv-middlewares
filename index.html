<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Middleware architectures in PHP with Zend Expressive </title>

        <meta name="description" content="Middleware architectures in PHP with Zend Expressive ">
        <meta name="author" content="Steve Maraspin">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/mv.css" id="theme">
        <link rel="stylesheet" href="css/style.css">

        <!-- Code syntax highlighting -->
        <link rel="stylesheet" href="lib/css/github.css">

        <link href="img/logos/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon" >

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="reveal">

            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">

                <section class="title" data-background="#7ab317">
                    <h1>Middleware architectures</h1>
                    <h2>in PHP with Zend Expressive </h2>
                </section>

                <!-- https://pixabay.com/en/balance-zen-objects-yoga-centered-2211334/  -->
                <section class="bkg" data-background="img/balance-2211334_1280.jpg">
                    <h1 class="borded">Middleware</h1>
                </section>

                <section class="simple">
                    <h1>SOA Middleware</h1>
                    <img src="img/middleware-soa.jpg">
                </section>

                <section class="simple">
                    <h1 class="strikethrough">Not today's topic</h1>
                    <img src="img/no-middleware-soa.jpg">
                    <aside class="notes">
                        <p>not the SOA Middleware</p>
                    </aside>
                </section>

                <!--  data-trim contenteditable -->
                <section class="simple">
                    <h1>Node.JS Middleware</h1>
                    <pre><code class="hljs">var express = require('express')
var app = express()

app.get('/', function (req, res) {
    res.send('Hello World!')
})

app.listen(3000)
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>That's closer...</h1>
                    <img src="img/middleware-node.png">
                </section>

                <section class="bkg" data-background="img/marco.jpg">
                    <h1 class="borded">Marco</h1>
                </section>

                <section class="bkg" data-background="img/explorer2.jpg">
                    <h1 class="top-right">Explorer</h1>
                    <aside class="notes">
                        <p>Mathematician, mountain environments</p>
                    </aside>
                </section>

                <section class="bkg" data-background="img/board.jpg">
                    <h1 class="low-right">Avid learner</h1>
                    <aside class="notes">
                        <p>Functional programming, Codemotion talk on ELM</p>
                    </aside>
                </section>

                <!-- https://pixabay.com/en/dark-chocolate-bar-food-2562840/ -->
                <section class="bkg" data-background="img/dark-2562840_1280.jpg">
                    <h1>Chocolate Lover</h1>
                    <aside class="notes">
                        <p>Vice</p>
                        <p>Besides being a Mathematician</p>
                        <p>Human being</p>
                    </aside>
                </section>

                <section class="bkg" data-background="img/steve2.jpg">
                    <h1>Steve</h1>
                </section>

                <!-- https://pixabay.com/en/camping-travel-sunrise-adventure-2581242/ -->
                <section class="bkg" data-background="img/camping-2581242_1280.jpg">
                    <h1>Enjoys Travelling</h1>
                    <aside class="notes">
                        <p>Experiencing new stuff</p>
                        <p>Exploring new environments</p>
                    </aside>
                </section>

                <!-- https://pixabay.com/en/architecture-skyscraper-1727807/ -->
                <section class="bkg" data-background="img/architecture-1727807_1280.jpg">
                    <h2>Software Architectures</h2>
                    <aside class="notes">
                        <p>Software Architectures</p>
                        <p>Hawaiian Shirts</p>
                        <p>Also Sports; Baseball Especially</p>
                    </aside>
                </section>

                <section class="bkg" data-background="img/hawaii_orioles.jpg">
                    <h1>In a few years...</h1>
                </section>

                <section>
                    <div class="space10">
                    <h4>Software Engineers at</h4>
                    <img src="img/logos/mva-logo.png">
                    <aside class="notes">
                        <p>Italy-based, North-East, not too far away from here...</p>
                        <p>Car Sharing, Hotel Entertainment, Finance, Startups...</p>
                    </aside>
                </section>

                <!-- https://pixabay.com/en/work-workaholic-writer-programmer-1627703/... -->
                <!-- https://pixabay.com/en/computer-code-coding-programming-1828603/ -->
                <section class="bkg" data-background="img/computer-1828603_1280.jpg">
                    <h1>How about you?</h1>
                </section>

                <section class="bkg" data-background="#fff">
                    <img src="img/symfony.png">
                    <img src="img/zf.jpg">
                </section>

                <section class="bkg" data-background="#fff">
                    <p>Dependency Injection</p>
                    <p>Value Objects</p>
                    <p>PSR-7</p>
                    <p>Zend Expressive</p>
                    <p>Middleware</p>
                </section>

                <!-- https://pixabay.com/en/lake-west-sunset-the-sun-sky-2522540/ -->
                <section class="bkg" data-background="img/lake-2522540_1280.jpg">
                    <h1>Plans for the day...</h1>
                </section>

                <!-- https://pixabay.com/en/school-old-plate-learning-1223872/ -->
                <section class="bkg" data-background="img/board-ze.jpg">
                </section>

                <section class="simple" data-background="#efefef">
                    <h1>A Nice Side effect...</h1>
                    <img src="img/zend-expressive-logo.png">
                </section>

                <section class="simple">
                    <h1>Zend Expressive</h1>
                    <p>...an easy to use, PSR-15, PSR-11, PSR-7 compliant middleware atomic micro-framework that works particularily well for small fully-featured web apps or API servers</p>
                </section>

                <section class="simple">
                    <h1>Let's Go!</h1>
                    <pre><code class="hljs" data-trim contenteditable>git checkout 01-expressive-skeleton</code></pre>
                </section>

                <section class="simple">
                    <h1>http://phpmiddleware.websc</h1>
                </section>

                <section class="bkg">
                    <img src="img/outcome.png">
                </section>

                <section class="simple">
                    <h1>Default Installation</h1>
                    <pre><code class="hljs" data-trim contenteditable>cd /var/www/html/summercamp/
composer create-project zendframework/zend-expressive-skeleton my-project
                    </code></pre>
                </section>

                <section class="bkg">
                    <img src="img/zend-expressive.png">
                </section>

                <section class="bkg" data-background="#2a2a2a">
                    <img src="img/installation.png">
                </section>

                <!-- https://pixabay.com/en/medicine-vials-bottle-treatment-1309148/ -->
                <section class="bkg" data-background="img/medicine-1309148_1280.jpg">
                    <h1>PIMPLE</h1>
                </section>

                <!-- https://pixabay.com/en/network-connection-pc-web-address-197300/ -->
                <section class="bkg" data-background="img/network-197300_1280.jpg">
                    <h1>FastRoute</h1>
                </section>

                <!-- https://pixabay.com/en/kitchen-culinary-cooks-helpers-81644/ -->
                <section class="bkg" data-background="img/kitchen-81644_1280.jpg">
                    <h1>Interoperability</h1>
                </section>

                <!-- https://pixabay.com/en/kitchen-culinary-cooks-helpers-81644/ -->
                <section class="bkg" data-background="img/kitchen-81644_1280.jpg">
                    <h1>Keyword for today</h1>
                </section>

                 <section class="bkg">
                    <img src="img/ze-stack.png">
                </section>

                <!-- https://pixabay.com/en/food-preparation-parts-wood-table-1081813/ -->
                <section class="bkg" data-background="img/food-preparation-1081813_1280.jpg">
                    <h1>Component Glue</h1>
                    <aside class="notes">
                        <p>Wrapper around existing stuff</p>
                        <p>supports multiple routers</p>
                        <p>PSR-7 Compliant</p>
                        <p>PSR-11 Compliant</p>
                        <p>supports multiple service locators</p>
                    </aside>
                </section>

                <section class="simple">
                    <h1>Filesystem layout</h1>
                    <pre><code class="hljs">
                    /var/www/html/summercamp/phpmiddleware
                    </code></pre>
                   <pre><code class="hljs">├── bin
├── config
├── data
├── public
│     └── index.php
├── src
├── test
└── vendor
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>Document Root</h1>
                    <pre><code class="hljs">
                    /var/www/html/summercamp/phpmiddleware/public
                    </code></pre>
                    <pre><code class="hljs">
                    /etc/apache2/sites-available/phpmiddleware.conf
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>public/index.php</h1>
                    <pre><code class="hljs">

chdir(dirname(__DIR__));
require 'vendor/autoload.php';

call_user_func(function () {
    /** @var \Interop\Container\ContainerInterface $container */
    $container = require 'config/container.php';

    /** @var \Zend\Expressive\Application $app */
    $app = $container->get(\Zend\Expressive\Application::class);

    require 'config/pipeline.php';
    require 'config/routes.php';

    $app->run();
});
                    </code></pre>
                </section>

                 <section class="simple">
                    <h1>config/container.php</h1>
                    <pre><code class="hljs">// Load configuration
$config = require __DIR__ . '/config.php';

$container = new Container();
$container['config'] = $config;

[...]
foreach ($config['dependencies']['services'] as $name => $service) {
    $container[$name] = function ($c) use ($service) {
        return $service;
    };
}
[...]

return $container;
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>config/config.php</h1>
                    <pre><code class="hljs">$cacheConfig = [
    'config_cache_path' => 'data/config-cache.php',
];
$aggregator = new ConfigAggregator([

    new ArrayProvider($cacheConfig),
    App\ConfigProvider::class,
    new PhpFileProvider('config/autoload/{{,*.}global,{,*.}local}.php'),
    new PhpFileProvider('config/development.config.php'),

], $cacheConfig['config_cache_path']);

return $aggregator->getMergedConfig();
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>public/index.php</h1>
                    <pre><code class="hljs">

chdir(dirname(__DIR__));
require 'vendor/autoload.php';

call_user_func(function () {
    /** @var \Interop\Container\ContainerInterface $container */
    $container = require 'config/container.php';

    /** @var \Zend\Expressive\Application $app */
    $app = $container->get(\Zend\Expressive\Application::class);

    require 'config/pipeline.php';
    require 'config/routes.php';

    $app->run();
});
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>config/routes.php</h1>
                    <pre><code class="hljs">$app->get('/', App\Action\HomePageAction::class, 'home');
$app->get('/api/ping', App\Action\PingAction::class, 'api.ping');</code></pre>
                </section>

                <section class="bkg">
                    <img src="img/outcome.png">
                </section>

                <section class="bkg">
                    <img src="img/404.png">
                </section>

                <section class="simple">
                    <h1>config/routes.php</h1>
                    <pre><code class="hljs">$app->get('/', App\Action\HomePageAction::class, 'home');
$app->get('/api/ping', App\Action\PingAction::class, 'api.ping');</code></pre>
                </section>

                <section class="bkg">
                    <img src="img/api-ping.png">
                </section>

                <section class="simple">
                    <h1>config/routes.php</h1>
                    <pre><code class="hljs">$app->get('/', App\Action\HomePageAction::class, 'home');
$app->get('/api/ping', App\Action\PingAction::class, 'api.ping');</code></pre>
                </section>

                <section class="simple">
                    <p>src/App/Action/PingAction.php</p>
                    <pre><code class="hljs">namespace App\Action;

[...]

class PingAction implements ServerMiddlewareInterface
{
    public function process(
        ServerRequestInterface $request,
        DelegateInterface $delegate
    ) {
        return new JsonResponse(['ack' => time()]);
    }
}

}
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>PSR-7 ResponseInterface</h1>
                    <pre><code class="hljs" data-trim contenteditable>namespace Psr\Http\Message;
interface ResponseInterface extends MessageInterface
{
    public function getStatusCode();
    public function withStatus($code, $reasonPhrase = '');
    public function getReasonPhrase();
}
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>PSR-7 ServerRequestInterface</h1>
                         <pre><code class="hljs" data-trim contenteditable>namespace Psr\Http\Message;

interface ServerRequestInterface extends RequestInterface
{
    public function getServerParams();
    public function getCookieParams();
    public function withCookieParams(array $cookies);
    public function getQueryParams();
    public function withQueryParams(array $query);
    public function getUploadedFiles();
    public function withUploadedFiles(array $uploadedFiles);
    public function getParsedBody();
    public function withParsedBody($data);
    public function getAttributes();
    public function getAttribute($name, $default = null);
    public function withAttribute($name, $value);
    public function withoutAttribute($name);
}
                        </code></pre>
                </section>

                <section class="simple">
                    <h1>Interacting with these...</h1>
                    <pre><code class="hljs" data-trim contenteditable>$response->setStatusCode(503);
                    </code></pre>
                    <pre><code class="hljs" data-trim contenteditable>$response = $response->withStatusCode(503);</code></pre>
                </section>

                <section class="bkg" data-background="img/diamond.jpg">
                    <h2>A Value object is forever</h2>
                    <aside class="notes">
                        <p>Objects whose identity is the aggregate of all the attributes of the object</p>
                        <p>Every time we alter a value object we do not mutate it, but we actually create a new one</p>
                        <p>Ensures the integrity of the state of the application</p>
                        <p>State determines identity</p>
                    </aside>
                </section>

                 <section class="simple">
                    <h1>Time to do stuff...</h1>
                    <pre><code class="hljs" data-trim contenteditable>git checkout 03-welcome</code></pre>
                </section>

                <section class="bkg">
                    <img src="img/03.png">
                </section>

                <section class="bkg">
                    <img src="img/es-01-def.png">
                </section>

                <section class="bkg">
                    <img src="img/es-01.png">
                </section>

                <section class="simple">
                    <h1>Exercise 1 (10 mins)</h1>
                    <p>get to branch 03-welcome</p>
                    <p>Create an hello route (/hello)</p>
                    <p>Display output {"hello":"NAME"}</p>
                    <p>NAME is either the value of the http GET name parameter, or the string random phper if no name parameter was provided</p>
                    <pre><code class="hljs" data-trim contenteditable>docs/readme.html</code></pre>
                </section>

                <section class="simple">
                    <h1>Exercise 1 Solution</h1>
                    <pre><code class="hljs">class HelloAction implements MiddlewareInterface
{
    public function process(
        ServerRequestInterface $request,
        DelegateInterface $delegate
    ): ResponseInterface
    {
        $query = $request->getQueryParams();

        $name = $query['name'] ?? 'random phper';

        return new JsonResponse([
            'hello' => $name
        ]);
    }
}
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>Check it out with</h1>
                    <pre><code class="hljs" data-trim contenteditable>git checkout 04-hello-name</code></pre>
                </section>

                <section class="simple">
                    <h1>Let's move on...</h1>
                    <pre><code class="hljs" data-trim contenteditable>git checkout 06-chocolates-route</code></pre>
                </section>

                <section class="bkg" data-background="img/dark-2562840_1280.jpg">
                    <h1>Our Domain</h1>
                </section>

                <section class="bkg">
                    <img src="img/07-choco.png">
                </section>

                <section class="simple">
                    <p>config/routes.php</p>
                    <pre><code class="hljs">$app->get('/', \App\Action\IndexAction::class, 'index');

$app->get('/hello', \App\Action\HelloAction::class, 'hello');

$app->get('/chocolates', \App\Action\ChocolatesAction::class, 'chocolates');
                    </code></pre>
                </section>

                <section class="simple">
                    <p>src/App/Action/ChocolatesAction.php</p>
                    <pre><code class="hljs">final class ChocolatesAction implements MiddlewareInterface
    {
        /**
         * @var ChocolatesServiceInterface
         */
        private $chocolates;

        public function __construct(ChocolatesServiceInterface $chocolates)
        {
            $this->chocolates = $chocolates;
        }

        public function process(ServerRequestInterface $request, DelegateInterface $delegate): ResponseInterface
        {
            $filters = $request->getQueryParams();

            return new JsonResponse($this->chocolates->getAll($filters));
        }
    }
                    </code></pre>
                </section>

                 <section class="simple">
                     <h1>config/config.php</h1>
                     <pre><code class="hljs">$cacheConfig = [
        'config_cache_path' => 'data/config-cache.php',
    ];

    $aggregator = new ConfigAggregator([
        new ArrayProvider($cacheConfig),
        App\ConfigProvider::class,
        new PhpFileProvider('config/autoload/{{,*.}global,{,*.}local}.php'),
        new PhpFileProvider('config/development.config.php'),
        ], $cacheConfig['config_cache_path']
    );

    return $aggregator->getMergedConfig();

                    </code></pre>
                </section>

                <section class="simple">
                    <p>src/App/ConfigProvider.php</p>
                    <pre><code class="hljs">public function getDependencies()
    {
      return [
        'factories'  => [
          // ACTIONS
          ChocolatesAction::class => ChocolatesActionFactory::class,

          // SERVICES
          ChocolatesServiceInterface::class => ChocolatesServiceFactory::class,

          // REPOSITORIES
          Chocolates::class => SqlChocolatesFactory::class,
        ],
      ];
    }
                    </code></pre>
                </section>

                <section class="simple">
                    <p>src/App/Container/Action/ChocolatesActionFactory.php</p>
                    <pre><code class="hljs">final class ChocolatesActionFactory
    {
        public function __invoke(ContainerInterface $container): ChocolatesAction
        {
            return new ChocolatesAction(
                $container->get(ChocolatesServiceInterface::class)
            );
        }
    }
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>PSR-11 ContainerInterface</h1>
                    <pre><code class="hljs" data-trim contenteditable>
                        interface ContainerInterface
    {
        public function get($serviceName);
        public function has($serviceName);
    }
                    </code></pre>
                </section>

                <section class="bkg">
                    <img src="img/08-choco-detail.png">
                </section>

                <section class="simple">
                    <h1>Exercise 2 (25 mins)</h1>
                    <p>get to branch 06-chocolates-route</p>
                    <h2>Alternative A - User List</h2>
                    <p>Create a users (/users) route</p>
                    <h2>Alternative B - Chocolate Details</h2>
                    <p>Create a chocolate-details (/chocolate/ID) route where ID is a proper ID of a chocolate wrapper in our domain</p>
                    <p>Interact with src/App/Domain/Service/ChocolatesService.php</p>
                    <pre><code class="hljs" data-trim contenteditable>docs/readme.html</code></pre>
                </section>

                <section class="simple">
                    <h1>Exercise 2 Solution</h1>
                    <pre><code class="hljs" data-trim contenteditable>final class ChocolateDetailsAction implements MiddlewareInterface
{
[...]
public function process(ServerRequestInterface $request, DelegateInterface $delegate): ResponseInterface
    {
        $chocolateId = ChocolateId::fromString($request->getAttribute('id'));

        $chocolate = $this->chocolatesService->getChocolate($chocolateId);

        return new JsonResponse($chocolate);
    }
}
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>You can check it out with</h1>
                     <pre><code class="hljs" data-trim contenteditable>git checkout 07-chocolate-details-route</code></pre>
                </section>

                <section class="simple">
                    <h1>Let's move forward...</h1>
                    <pre><code class="hljs" data-trim contenteditable>git checkout 09-users-details-route</code></pre>
                </section>

                <section class="simple">
                    <h1>Factories for multiple named services</h1>
                    <pre><code class="hljs" data-trim contenteditable>namespace App\Container\Action;

use App\Domain\Service\ChocolatesServiceInterface;
use App\Domain\Service\UsersServiceInterface;
use Interop\Container\ContainerInterface;

final class ChocolatesAndUsersActionFactory
{
    public function __invoke(ContainerInterface $container, string $name)
    {
        return new $name(
            $container->get(ChocolatesServiceInterface::class),
            $container->get(UsersServiceInterface::class)
        );
    }
}
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>FactoryInterface</h1>
                    <pre><code class="hljs" data-trim contenteditable>

    public function __invoke(
        ContainerInterface $container,
        string $name,
        array $options = null
    )
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>But hey, did you notice?</h1>
                    <pre><code class="hljs" data-trim contenteditable>final class ChocolateDetailsAction implements MiddlewareInterface
{
[...]
public function process(ServerRequestInterface $request, DelegateInterface $delegate): ResponseInterface
    {
        $chocolateId = ChocolateId::fromString($request->getAttribute('id'));

        $chocolate = $this->chocolatesService->getChocolate($chocolateId);

        return new JsonResponse($chocolate);
    }
}
                    </code></pre>
                </section>

                <section class="bkg" data-background="img/cutting-onion.jpg">
                    <h1 >We used Middleware</h1>
                    <pre><code class="hljs" data-trim contenteditable>
public function process(
        ServerRequestInterface $request,
        DelegateInterface $delegate
    ): ResponseInterface
{
    ...

    response =  $delegate->process($request);
    $response = $response->withStatusCode(200);

    ...

    return response;
}
                    </code></pre>
                </section>

                <section class="simple">
                    <h1 class="bkg">Middleware</h1>
                    <img src="img/kernel.png">
                    <aside class="notes">
                        <p>Middleware is about taking a request and turning it into a response</p>
                    </aside>
                </section>

                <section class="bkg" data-background="img/onion1.jpg">
                    <h1 class="bkg">Middleware</h1>
                </section>

               <section class="bkg" data-background="img/onion-middleware2.jpg">
                    <aside class="notes">
                        <p>Infinitely nestable components</p>
                        <p>Decorate Request/Response handling</p>
                        <p>Layers traversed in/out</p>
                    </aside>
                </section>

                <section>
                    <img src="img/flight-1.png">
                </section>

                <section>
                    <img src="img/flight-2.png">
                </section>

                <section>
                    <img src="img/flight-3.png">
                </section>

                <section class="simple">
                    <img src="img/book_cover.gif">
                </section>

                <section class="simple">
                    <h1>Pipes and filters</h1>
                    <img src="img/pipes-filters.png">
                </section>

                <section class="simple">
                    <h1>Pizza Example</h1>
                    <img src="img/pipes-filters-pizza.png">
                </section>

                <section class="bkg" data-background="img/margherita.jpg">
                    <h1>Decorator</h1>
                    <aside class="notes">
                        <p>Pipes and filters is linear, we would like to compose things in a more general way</p>
                        <p>Alternative to subclassing for extending functionality</p>
                    </aside>
                </section>

                <section data-background="img/cheese-vegetables.jpg" class="simple">
                    <pre><code class="hljs" data-trim contenteditable>
interface Pizza

class Margherita implements Pizza

class CheeseDecoratedPizza implements Pizza
{
    function __construct(Pizza $pizza)
}

class VegetablesDecoratedPizza implements Pizza
{
    function __construct(Pizza $pizza)
}
                    </code></pre>

                    <aside class="notes">
                        <p>Conform to the interface of the decorated object</p>
                        <p>Its presence is transparent to the client</p>
                    </aside>
                </section>

                <section data-background="img/pizza.jpg" class="simple">
                    <pre><code class="hljs" data-trim contenteditable>
$myFavouritePizza =

    new VegatablesDecoratedPizza(

        new CheeseDecoratedPizza(

            new Margherita()

        )

    );
                    </code></pre>
                    <aside class="notes">
                        <p>Recursive nesting</p>
                        <p>Responsabilities added and removed at runtime</p>
                        <p>Unlimited number of added responsabilities</p>
                    </aside>
                </section>

                <!-- https://pixabay.com/en/baggage-hall-heathrow-airport-775540/ -->
                <section class="bkg" data-background="img/baggage-hall-775540_1280.jpg">
                    <h1>Cross cutting concerns</h1>
                </section>

                <section class="simple">
                    <h1>Back to code...</h1>
                    <pre><code class="hljs">git checkout 10-access-log</code></pre>
                </section>

                <section class="simple">
                    <p>config/pipeline.php</p>
                    <pre><code class="hljs">$app->pipe(new \Middlewares\ClientIp());
$app->pipe(\Middlewares\AccessLog::class);
                    </code></pre>
                </section>

                <section class="simple">
                    <p>src/App/ConfigProvider.php</p>
                    <pre><code class="hljs">  public function getDependencies()
    {
        return [
            'factories'  => [
                // ACTIONS
                ChocolatesAction::class => ChocolatesServiceActionFactory::class,
                ChocolateDetailsAction::class => ChocolatesServiceActionFactory::class,
                UsersAction::class => UsersServiceActionFactory::class,
                UserDetailsAction::class => UsersServiceActionFactory::class,

                // SERVICES
                ChocolatesServiceInterface::class => ChocolatesServiceFactory::class,
                UsersServiceInterface::class => UsersServiceFactory::class,

                // REPOSITORIES
                Chocolates::class => SqlRepositoryFactory::class,
                Users::class => SqlRepositoryFactory::class,
            ],
        ];
    }
                    </code></pre>
                </section>

                <section class="simple">
                    <p>src/App/Container/Middleware/AccessLogFactory.php</p>
                    <pre><code class="hljs">use Middlewares\AccessLog;
use Monolog\Handler\StreamHandler;
use Monolog\Logger;

final class AccessLogFactory
{
    public function __invoke(ContainerInterface $container)
    {
        $logger = new Logger('access');
        $filePath = $container->get('config')['access_log']['path'];
        $logger->pushHandler(new StreamHandler($filePath));

        $accessLog = new AccessLog($logger);

        $accessLog->format('%v %h %u %t "%r" %>s %b "%{Referer}i" -> %U "%{User-Agent}i" ClientIp: %a Duration: %{us}T');
        $accessLog->ipAttribute('client-ip');

        return $accessLog;
    }
}
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>Exercise 3 (25 mins)</h1>
                    <p>Get to branch 10-access-log</p>
                    <p>Create a caching middleware</p>
                    <p>For all http GET requests, make sure that a cached result is returned</p>
                    <pre><code class="hljs" data-trim contenteditable>docs/readme.html</code></pre>
                </section>

                <section class="simple">
                    <h1>Solution to exercise 3</h1>
                    <pre><code class="hljs" data-trim contenteditable>git checkout 11-response-cache</code></pre>
                    <p>Implementing middleware from scratch - not necessarily a good idea!</p>
                </section>

                <section class="bkg" data-background="img/reinventing-wheel.jpg">
                    <h1>Reinventing the Wheel</h1>
                    <aside class="notes">
                        <p>Silos</p>
                        <p>Meaningless Rivalries</p>
                        <p>Closed Communities</p>
                        <p>Waste</p>
                        <p>How to solve this?</p>
                    </aside>
                </section>

                <!-- https://pixabay.com/en/dinosaur-amusement-park-dino-park-875614/ -->
                 <section class="bkg" data-background="img/dinosaur-875614_1280.jpg">
                </section>

                <section>
                    <h1>Already Available Middleware</h1>
                    <ul>
                    <li>Storage-Less Sessions</li>
                    <li>Device Detection</li>
                    <li>Analytics Support</li>
                    <li>Robot-Blocking</li>
                    <li>Request Rate Limiting</li>
                    <li>And More...</li>
                    </ul>
                </section>

                <section class="simple" data-background="#151d28">
                    <div class="space10">
                    <a href="http://php-middleworld.com"><img src="img/logos/phpmiddleworld.png"></a>
                </section>

                <!-- https://pixabay.com/en/roe-deer-food-self-service-feed-2652430/ -->
                <section class="bkg" data-background="img/roe-deer-2652430_1280.jpg">
                    <h1>Easy, isn't it?</h1>
                </section>


                <section class="simple">
                    <h1>How about other actions?</h1>
                    <pre><code class="hljs" data-trim contenteditable>git checkout 15-delete-chocolate</code></pre>
                </section>

                <section class="simple">
                    <h1>config/routes.php</h1>
                    <pre><code class="hljs" data-trim contenteditable>
$app->post('/submit', \App\Action\SubmitChocolateAction::class, 'submit');

$app->post(
    '/approve/{id:[0-9a-f]{8}\-[0-9a-f]{4}\-[0-9a-f]{4}\-[0-9a-f]{4}\-[0-9a-f]{12}}',
    \App\Action\ApproveChocolateAction::class,
    'approve'
);

$app->post(
    '/delete/{id:[0-9a-f]{8}\-[0-9a-f]{4}\-[0-9a-f]{4}\-[0-9a-f]{4}\-[0-9a-f]{12}}',
    \App\Action\DeleteChocolateAction::class,
    'delete'
);
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>Related Actions</h1>
                     <pre><code class="hljs" data-trim contenteditable>App\Action\SubmitChocolateAction.php</code></pre>
                     <pre><code class="hljs" data-trim contenteditable>App\Action\ApproveChocolateAction.php</code></pre>
                     <pre><code class="hljs" data-trim contenteditable>App\Action\DeleteChocolateAction.php</code></pre>
                </section>

                <section class="simple">
                    <h1>What about authentication?</h1>
                    <pre><code class="hljs" data-trim contenteditable>git checkout 16.1-basic-http-authentication</code></pre>
                </section>

                <section class="simple">
                    <h1>config/routes.php</h1>
                    <pre><code class="hljs" data-trim contenteditable>
$app->post(
    '/submit',
    [
        \Middlewares\HttpAuthentication::class,
        \App\Action\SubmitChocolateAction::class,
    ],
    'submit'
);

$app->post(
    '/approve/{id:[0-9a-f]{8}\-[0-9a-f]{4}\-[0-9a-f]{4}\-[0-9a-f]{4}\-[0-9a-f]{12}}',
    [
        \Middlewares\HttpAuthentication::class,
        \App\Action\ApproveChocolateAction::class,
    ],
    'approve'
);

[...]

                    </code></pre>
                </section>

                <section class="simple">
                    <p>src/App/Container/Middleware/BasicHttpAuthenticationFactory.php</p>
                    <pre><code class="hljs" data-trim contenteditable>final class BasicHttpAuthenticationFactory
{
    public function __invoke(ContainerInterface $container): HttpAuthentication
    {
        /** @var UsersServiceInterface $users */
        $users = $container->get(UsersServiceInterface::class);

        $credentials = array_reduce(
            $users->getAll(),
            function (array $carry, User $user) {
                $carry[$user->username()] = $user->password();
                return $carry;
            },
            []
        );

        return (new BasicAuthentication($credentials))->attribute(HttpAuthentication::class);
    }
}
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>Let's switch to JWT...</h1>
                    <pre><code class="hljs" data-trim contenteditable>git checkout 17.3-jwt-authentication</code></pre>
                </section>

                <section class="simple">
                    <h1>config/routes.php</h1>
                    <pre><code class="hljs" data-trim contenteditable>$app->post(
    '/submit',
    [
        \Middlewares\HttpAuthentication::class,
        \App\Action\SubmitChocolateAction::class,
    ],
    'submit'
);

$app->post(
    '/approve/{id:[0-9a-f]{8}\-[0-9a-f]{4}\-[0-9a-f]{4}\-[0-9a-f]{4}\-[0-9a-f]{12}}',
    [
        \Middlewares\HttpAuthentication::class,
        \App\Action\ApproveChocolateAction::class,
    ],
    'approve'
);
                    </code></pre>
                </section>

                <section class="simple">
                    <h1>JWT (add slides)</h1>
                    <pre><code class="hljs" data-trim contenteditable>non mi è chiaro come abilitata auth JWT su questo branch...</code></pre>
                </section>

                <section class="simple">
                    <h1>Exercise 4 (30 mins)</h1>
                    <p>Get to branch 17.1-basic-http-authentication</p>
                    <h2>Alternative A - JWT Authentication</h2>
                    <p>Implement JWT Authentication</p>
                    <h2>Alternative B - Authorization</h2>
                    <p>Allow for authenticated users only to submit new wrappers</p>
                    <p>Allow for administrators only to approve/delete wrappers</p>
                    <pre><code class="hljs" data-trim contenteditable>docs/readme.html</code></pre>
                </section>

                <section class="simple">
                    <h1>Solution to exercise 4</h1>
                    <pre><code class="hljs" data-trim contenteditable>git checkout 18-authorization</code></pre>
                </section>

                <section class="simple">
                    <h1>config/routes.php</h1>
                    <pre><code class="hljs" data-trim contenteditable>$app->post(
    '/submit',
    [
        \Middlewares\HttpAuthentication::class,
        \App\Action\SubmitChocolateAction::class,
    ],
    'submit'
);

$app->post(
    '/approve/{id:[0-9a-f]{8}\-[0-9a-f]{4}\-[0-9a-f]{4}\-[0-9a-f]{4}\-[0-9a-f]{12}}',
    [
        \Middlewares\HttpAuthentication::class,
        \App\Middleware\Authorization::class,
        \App\Action\ApproveChocolateAction::class,
    ],
    'approve'
);
                    </code></pre>
                </section>

                <section class="simple">
                    <p>src/App/Middleware/Authorisation.php</p>
                    <pre><code class="hljs" data-trim contenteditable> public function process(ServerRequestInterface $request, DelegateInterface $delegate): ResponseInterface
    {
        $username = $request->getAttribute(JwtAuthentication::class)->data->username;

        $user = $this->usersService->getByUsername($username);

        if (! $user->isAdministrator()) {
            return new EmptyResponse(403);
        }

        return $delegate->process($request);
    }
                    </code></pre>
                </section>

                <!-- https://pixabay.com/en/crash-test-collision-60-km-h-1620592/ -->
                <section class="bkg" data-background="img/crash-test-1620592_1280.jpg">
                    <!-- If time allows -->
                    <h1 class="bkg">What About Testing</h1>
                </section>

                <section class="simple">
                    <h1>Exercise 5 (bonus)</h1>
                    <p>let's write a test for the Authorization Middleware of the last exercise</p>
                    <pre><code class="hljs">docs/readme.html</code></pre>
                </section>

                <section class="simple">
                    <h1>Solution to exercise 5</h1>
                    <pre><code class="hljs">git checkout (?)</code></pre>
                </section>

                <!-- https://pixabay.com/en/cattle-show-customs-appenzellerland-1703263/ -->
                <section class="bkg" data-background="img/cattle-show-1703263_1280.jpg">
                    <h1 class="bkg">Takeaways</h1>
                </section>

                <section class="simple" data-background="#efefef">
                    <img src="img/zend-expressive-logo.png">
                </section>

                <section class="bkg" data-background="img/onion1.jpg">
                    <h1 class="bkg">Middleware</h1>
                </section>

                <section class="bkg">
                    <h1>What about other frameworks?</h1>
                </section>

                <section class="simple">
                    <h3>Slim</h3>
                    <img src="img/logos/slim-small.png">
                    <aside class="notes">
                        <p>Microframework based on PSR-7</p>
                    </aside>
                </section>

                <section class="simple">
                    <h3>Slim</h3>
                    <pre><code class="hljs" data-trim contenteditable>
// src/middleware.php

$app->add(new AccessLog($logger));

$app->add(new Geolocate());

$app->add(new ClientIp());

$app->add(new BasicAuthentication($users));
                    </code></pre>

                    <aside class="notes">
                        <p>Microframework based on PSR-7</p>
                        <p>The last middleware added is the first to be executed</p>
                    </aside>
                </section>

                <section class="simple">
                    <h3>Radar & Relay</h3>
                    <img src="img/logos/relay.png">
                </section>

                <section class="simple">
                    <h3>Radar & Relay</h3>
                    <pre><code class="hljs" data-trim contenteditable>
// web/index.php

$adr->middle(new BasicAuthentication($users));

$adr->middle(new ClientIp());

$adr->middle(new Geolocate());

$adr->middle(new AccessLog($logger));
                    </code></pre>
                    <aside class="notes">
                        <ul>
                            <li>Action-Domain-Responder framework</li>
                            <li>Relay: PSR-7 Middleware Dispatcher</li>
                            <li>FIFO Middleware Stack</li>
                        </ul>
                    </aside>
                </section>

                <section>
                     <img src="img/final.png">
                      <aside class="notes">
                            <ul>
                                <li>Slim/Http Zend Diactoros</li>
                                <li>Expressive-Stratigility by Extension</li>
                                <li>Radar-Relay by Composition</li>
                                <li>Slim provides everything</li>
                                <li>Middleware runs everywhere!</li>
                            </ul>
                    </aside>
                </section>

                <!-- https://pixabay.com/en/kitchen-culinary-cooks-helpers-81644/ -->
                <section class="bkg" data-background="img/kitchen-81644_1280.jpg">
                    <h1>Told'ya!</h1>
                </section>

                <!-- https://pixabay.com/en/theater-cinema-curtain-stripes-1713816/ -->
                <section class="bkg" data-background="img/theater-1713816_1280.jpg">
                    <h1>Thank you very much</h1>
                </section>

                <section>
                    <div class="space10">
                    <h4>Stay tuned for more...</h4>
                    <img src="img/logos/mva-logo.png">
                    <aside class="notes">
                        <p>Italy-based, North-East</p>
                        <p>Enterprise Internet applications</p>
                        <p>Car Sharing, Hotel Entertainment, Finance, Startups...</p>
                    </aside>
                </section>

                <section>
                    <h1>Speakers love feedback</h1>
                    <img src="img/joindin.png">
                    <p>Leave your feedback at <a href="https://joind.in/talk/668cc">https://joind.in/talk/668cc</a></p>
                    <div class="space5">
                    <p>Marco <a href="https://twitter.com/marcoshuttle">@marcoshuttle</a> <a href="mailto:m.perone@mvlabs.it">m.perone@mvlabs.it</a></p>
                    <p>Steve <a href="https://twitter.com/maraspin">@maraspin</a> <a href="mailto:s.maraspin@mvlabs.it">s.maraspin@mvlabs.it</a></p>
                </section>

                <section>
                    <h1>Resources</h1>
                    <div class="credits">
                        <p><a href="https://mwop.net/blog/2015-01-26-psr-7-by-example.html">PSR-7 By Example</a> by <a href="https://twitter.com/mwop">Matthew Weier O'Phinney</a></p>
                        <p><a href="https://mwop.net/blog/2015-01-08-on-http-middleware-and-psr-7.html">On HTTP, Middleware, and PSR-7</a> by <a href="https://twitter.com/mwop">Matthew Weier O'Phinney</a></p>
                        <p><a href="http://www.slimframework.com/">Slim framework</a> documentation</p>
                        <p><a href="https://akrabat.com/category/slim-framework/">Slim resources</a> by <a href="https://twitter.com/akrabat">
                        <p><a href="https://github.com/radarphp/Radar.Project/tree/1.x/docs">Radar</a> documentation</p>
                        <p><a href="http://paul-m-jones.com/">Radar and middleware resources</a> by <a href="https://twitter.com/pmjones">Paul M. Jones</p>
                        <p><a href="https://zendframework.github.io/zend-expressive/">Zend Expressive</a> documentation</p>
                        <p><a href="https://github.com/php-fig/fig-standards/blob/95aece5e68376e9a5d79d2385d755824dfac3ed8/proposed/middleware-meta.md">Proposed Middleware Interface PSR-N</a>
                    </div>
                </section>

                <section>
                    <h1>Credits</h1>
                    <div class="credits">
                        <div style="float: left; width: 50%">
                        <p>Plane view by <a href="https://www.youtube.com/watch?v=0sazEDzCHAw">Victor Costan</a></p>
                        <p>Chocolate by <a href="https://www.flickr.com/photos/8510225@N07/606739059">John Loo</a></p>
                        <p>Orioles Fan by <a href="https://www.flickr.com/photos/keithallison/19019662724">Keith Allison</a></p>
                        <p>Mosque by <a href="https://commons.wikimedia.org/wiki/File:Beautiful_Architecture_of_Faisal_Mosque.jpg">Fasihjee</a></p>
                        <p>Fans by <a href="https://www.flickr.com/photos/108176838@N08/10751429014">Mirage Kale</a></p>
                        <p>Hippies by <a href="https://commons.wikimedia.org/wiki/File:1970-Isle_of_Wight_Festival-_5.JPG">Roland Godefroy</a></p>
                        <p>Hippie Van by <a href="https://en.wikipedia.org/wiki/Merry_Pranksters">Joe Mabel</a></p>
                        <p>Students by <a href="https://commons.wikimedia.org/wiki/File:Shimer_College_class_discussion_1967.jpg">Shimer College</a></p>
<p>Rave by <a href="https://www.youtube.com/watch?v=3aDthA9uGOY">EDM Playlist</a></p>
<p>Weird Bicicle by <a href="https://www.flickr.com/photos/thomasguest/5491482766">Thomas Guest</a></p>
<p>Suitcase found at <a href="http://www.publicdomainpictures.net/view-image.php?image=41590&picture=travel-suitcase-holiday">publicdomainpictures.net</a></p>
<p>A320 model found at <a href="http://wesharepics.info/imageugkl-united-airlines-png.asp">wesharepics.info</a></p>
<p>Beatles picture by <a href="https://en.wikipedia.org/wiki/File:The_Bealtes_with_Jimmie_Nicol_916-5099.jpg">Nationaal Archief</a></p>
<p>Beatles picture by <a href="https://en.wikipedia.org/wiki/File:The_Beatles_in_America.JPG">United Press Intl.</a></p>
 <p>Board by <a href="https://pixabay.com/en/mathematics-math-abstract-algebra-327488/">ericfleming8</a></p>
<p>Abstract painting by <a href="https://commons.wikimedia.org/wiki/File%3AUntitled_(Abstraction_No._3).jpg">Earle M. Pilgrim</a></p>
                        </div>

                        <div style="float:right; width: 50%">
                            <p>Figs by <a href="https://commons.wikimedia.org/wiki/File%3A%D9%82%D8%B7%D9%8A%D9%86.JPG">Mburnat</a></p>
                            <p>Kungsleden by <a href="https://commons.wikimedia.org/wiki/File%3AKungsleden_trail.JPG">Shyguy24x7</a></p>
                            <p>Danger zone by <a href="https://www.flickr.com/photos/cvander/2604370414">cvander</a></p>
                            <p>PSR-7 diagram by <a href="https://twitter.com/ninjagrlstuff">ninjagrl</a></p>
                            <p>Diamond by <a href="https://pixabay.com/en/diamond-shiny-baby-wealth-wealthy-807979/">EWAR</a></p>
                            <!--p>Eternity range by <a href="https://commons.wikimedia.org/w/index.php?curid=16328241">euphro</a></p-->
                            <!--p>Aeonium by <a href="https://commons.wikimedia.org/wiki/File%3AAeonium_tabuliforme.jpg">Max Ronnersjö</a></p-->
                            <!--p>Nest by <a href="https://commons.wikimedia.org/wiki/File%3AAmerican_Robin_Nest_with_Eggs.jpg">Laslovarga</a></p-->
                            <!--p>Decorated ice-cream by <a href="https://commons.wikimedia.org/wiki/File%3AGelato_Cup_Ice-cream_Cake_Cow.jpg">Sky22688</a></p-->
                            <p>Pizza by <a href="https://commons.wikimedia.org/w/index.php?curid=372337">ElfQrin</a></p>
                            <p>Cheese and vegetables by <a href="https://pixabay.com/en/tomatoes-bocconcini-cheese-salad-925698">StockSnap</a></p>
                            <p>Pizza by <a href="https://commons.wikimedia.org/wiki/File%3ASupreme_pizza.jpg">Scott bauer</a></p>
                            <p>Onion by <a href="https://commons.wikimedia.org/w/index.php?curid=19181714">Colin</a></p>
                            <p>Onion by <a href="https://commons.wikimedia.org/wiki/File%3ARed_onion_cross_section_03.jpg">Amada44</a></p>
                        </div>
                        <div style="float:right; width: 50%">
                            <p>Cutting onion by <a href="https://commons.wikimedia.org/w/index.php?curid=10531047">Lali Masriera</a></p>
                            <p>Onion by <a href="https://www.flickr.com/photos/darwinbell/303892944">darwinbell</a></p>
                            <p>Onion by <a href="https://pixabay.com/en/onion-red-onion-fruit-vegetable-899095">costanzimarco</a></p>
                            <p>Onion by <a href="https://pixabay.com/en/onion-flower-seed-farming-crop-284512/">sarangib</a></p>
                            <p>Locked door by <a href="https://www.pexels.com/photo/door-green-closed-lock-4291/">LEEROY.ca</a></p>
                            <p>Log by <a href="https://en.wikipedia.org/wiki/Logging#/media/File:Logging_in_Finnish_Lapland.jpg">Greenpeace Finland</a></p>
                        </div>
                    </div>
                </section>

            </div>

            <footer>
                <div class="details">
                Web Summer Camp - Rovinj, Croatia, Aug 30<sup>th</sup> 2017 -
                <a href="https://twitter.com/marcoshuttle">@marcoshuttle</a>
                <a href="https://twitter.com/maraspin">@maraspin</a>
                 <img src="img/logo.png" height="25">
                </div>
            </footer>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>

            // Full list of configuration options available at:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: false,
                progress: true,
                history: true,
                center: false,
                slideNumber: false,

                transition: 'slide', // none/fade/slide/convex/concave/zoom

                // Optional reveal.js plugins
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true },
                    { src: 'plugin/notes/notes.js', async: true }
                ]
            });

        </script>

    </body>
</html>
